<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - CinemaPulse</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="navbar-content">
            <div class="logo">üé¨ CinemaPulse Admin</div>
            <ul class="nav-links">
                <li><a href="/dashboard">Dashboard</a></li>
                <li><a href="/analytics">Analytics</a></li>
                <li><a href="/admin">Admin Panel</a></li>
                <li><a href="/" onclick="sessionStorage.clear()">Logout</a></li>
            </ul>
        </div>
    </nav>
    
    <div class="container">
        <div class="page-header">
            <h1>Admin Panel</h1>
            <p>Manage movies and platform content</p>
        </div>
        
        <!-- Quick Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="total-movies">0</div>
                <div class="stat-label">Total Movies</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-value" id="total-users">0</div>
                <div class="stat-label">Total Users</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-value" id="total-feedback">0</div>
                <div class="stat-label">Total Feedback</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-value">Admin</div>
                <div class="stat-label">Current Role</div>
            </div>
        </div>
        
        <!-- Add Movie Section -->
        <div class="card" style="max-width: 800px; margin: 3rem auto;">
            <h2 style="margin-bottom: 1.5rem;">‚ûï Add New Movie</h2>
            
            <form id="addMovieForm">
                <div class="form-group">
                    <label for="title">Movie Title *</label>
                    <input type="text" id="title" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label for="genre">Genre *</label>
                    <select id="genre" class="form-control" required>
                        <option value="">Select Genre</option>
                        <option value="Action">Action</option>
                        <option value="Comedy">Comedy</option>
                        <option value="Drama">Drama</option>
                        <option value="Horror">Horror</option>
                        <option value="Romance">Romance</option>
                        <option value="Sci-Fi">Sci-Fi</option>
                        <option value="Thriller">Thriller</option>
                        <option value="Documentary">Documentary</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="description">Description *</label>
                    <textarea id="description" class="form-control" rows="4" required></textarea>
                </div>
                
                <div class="form-group">
                    <label for="poster_url">Poster Image</label>
                    
                    <!-- Tab for URL or Upload -->
                    <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                        <button type="button" id="url-tab" class="tab-btn active" onclick="showUrlInput()">
                            üîó Image URL
                        </button>
                        <button type="button" id="upload-tab" class="tab-btn" onclick="showUploadInput()">
                            üì§ Upload Image
                        </button>
                    </div>
                    
                    <!-- URL Input -->
                    <div id="url-input-section">
                        <input type="url" id="poster_url" class="form-control" 
                               placeholder="https://images.unsplash.com/photo-...">
                        <small style="color: var(--text-gray); display: block; margin-top: 0.5rem;">
                            üí° Tip: Use <a href="https://unsplash.com/s/photos/movie" target="_blank" style="color: var(--primary);">Unsplash</a> 
                            - Right-click image ‚Üí Copy image address
                        </small>
                    </div>
                    
                    <!-- File Upload -->
                    <div id="upload-input-section" style="display: none;">
                        <input type="file" id="poster_file" class="form-control" 
                               accept="image/*" onchange="previewImage(this)">
                        <div id="image-preview" style="margin-top: 1rem;"></div>
                        <small style="color: var(--text-gray); display: block; margin-top: 0.5rem;">
                            üìÅ Supported: JPG, PNG, GIF (max 5MB)
                        </small>
                    </div>
                </div>
                
                <button type="submit" class="btn btn-primary">Add Movie</button>
            </form>
            
            <div id="add-movie-message" style="display: none; margin-top: 1rem;"></div>
        </div>
        
        <!-- Existing Movies -->
        <div style="margin-top: 3rem;">
            <h2 style="margin-bottom: 1.5rem;">üé¨ Manage Movies</h2>
            <div id="movies-list" style="display: grid; gap: 1rem;">
                <p style="text-align: center; color: var(--text-gray);">Loading movies...</p>
            </div>
        </div>
    </div>
    
    <script>
        // Tab switching for poster input
        function showUrlInput() {
            document.getElementById('url-input-section').style.display = 'block';
            document.getElementById('upload-input-section').style.display = 'none';
            document.getElementById('url-tab').classList.add('active');
            document.getElementById('upload-tab').classList.remove('active');
        }
        
        function showUploadInput() {
            document.getElementById('url-input-section').style.display = 'none';
            document.getElementById('upload-input-section').style.display = 'block';
            document.getElementById('url-tab').classList.remove('active');
            document.getElementById('upload-tab').classList.add('active');
        }
        
        // Image preview
        function previewImage(input) {
            const preview = document.getElementById('image-preview');
            
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    preview.innerHTML = `
                        <img src="${e.target.result}" alt="Preview" 
                             style="max-width: 300px; max-height: 400px; border-radius: 8px; border: 2px solid var(--primary);">
                    `;
                };
                
                reader.readAsDataURL(input.files[0]);
            }
        }
        
        // Load stats
        async function loadStats() {
            try {
                // Load movies count
                const moviesRes = await fetch('/api/movies');
                const moviesData = await moviesRes.json();
                document.getElementById('total-movies').textContent = moviesData.movies?.length || 0;
                
                // Load user count
                const usersRes = await fetch('/api/admin/users');
                const usersData = await usersRes.json();
                if (usersData.success) {
                    document.getElementById('total-users').textContent = usersData.count || 0;
                }
                
                // Load analytics for other stats
                const analyticsRes = await fetch('/api/analytics');
                const analyticsData = await analyticsRes.json();
                if (analyticsData.success) {
                    document.getElementById('total-feedback').textContent = analyticsData.analytics.total_reviews;
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }
        
        // Add movie form
        document.getElementById('addMovieForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const messageDiv = document.getElementById('add-movie-message');
            messageDiv.style.display = 'none';
            
            let posterUrl = document.getElementById('poster_url').value;
            const fileInput = document.getElementById('poster_file');
            
            // If file is uploaded, upload it first
            if (fileInput.files && fileInput.files[0]) {
                const formData = new FormData();
                formData.append('file', fileInput.files[0]);
                
                try {
                    const uploadRes = await fetch('/api/admin/upload-poster', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const uploadData = await uploadRes.json();
                    
                    if (uploadData.success) {
                        posterUrl = uploadData.url;
                    } else {
                        messageDiv.style.display = 'block';
                        messageDiv.style.color = '#ff4444';
                        messageDiv.textContent = '‚úó Failed to upload image: ' + uploadData.error;
                        return;
                    }
                } catch (error) {
                    messageDiv.style.display = 'block';
                    messageDiv.style.color = '#ff4444';
                    messageDiv.textContent = '‚úó Error uploading image';
                    return;
                }
            }
            
            // If no URL and no file, use placeholder
            if (!posterUrl) {
                posterUrl = 'https://via.placeholder.com/400x600/1a1f3a/00d9ff?text=' + 
                            encodeURIComponent(document.getElementById('title').value);
            }
            
            const data = {
                title: document.getElementById('title').value,
                genre: document.getElementById('genre').value,
                description: document.getElementById('description').value,
                poster_url: posterUrl
            };
            
            try {
                const response = await fetch('/api/admin/movies', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    messageDiv.style.display = 'block';
                    messageDiv.style.color = 'var(--success)';
                    messageDiv.textContent = '‚úì Movie added successfully!';
                    document.getElementById('addMovieForm').reset();
                    document.getElementById('image-preview').innerHTML = '';
                    loadMoviesList();
                    loadStats();
                } else {
                    messageDiv.style.display = 'block';
                    messageDiv.style.color = '#ff4444';
                    messageDiv.textContent = '‚úó ' + (result.error || 'Failed to add movie');
                }
            } catch (error) {
                console.error('Error adding movie:', error);
                messageDiv.style.display = 'block';
                messageDiv.style.color = '#ff4444';
                messageDiv.textContent = '‚úó Error adding movie. Please try again.';
            }
        });
        
        // Load movies list
        async function loadMoviesList() {
            try {
                const response = await fetch('/api/movies');
                const data = await response.json();
                
                const container = document.getElementById('movies-list');
                container.innerHTML = '';
                
                if (!data.success || data.movies.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: var(--text-gray);">No movies yet. Add your first movie above!</p>';
                    return;
                }
                
                data.movies.forEach(movie => {
                    const card = document.createElement('div');
                    card.className = 'movie-stat-card';
                    card.innerHTML = `
                        <div style="display: flex; gap: 1rem; align-items: center;">
                            <img src="${movie.poster}" alt="${movie.title}" 
                                 style="width: 80px; height: 120px; object-fit: cover; border-radius: 8px;">
                            <div>
                                <h3 style="margin-bottom: 0.5rem;">${movie.title}</h3>
                                <p style="color: var(--text-gray); margin: 0;">
                                    Genre: ${movie.genre || 'N/A'} ‚Ä¢ 
                                    ${movie.total_reviews} reviews ‚Ä¢ 
                                    Rating: <strong style="color: var(--primary);">${movie.rating.toFixed(1)}/5</strong>
                                </p>
                            </div>
                        </div>
                        <button onclick="deleteMovie(${movie.id}, '${movie.title}')" 
                                class="btn btn-secondary" style="width: auto;">
                            üóëÔ∏è Delete
                        </button>
                    `;
                    container.appendChild(card);
                });
            } catch (error) {
                console.error('Error loading movies:', error);
            }
        }
        
        // Delete movie
        async function deleteMovie(id, title) {
            if (!confirm(`Delete "${title}"? This will also delete all its reviews!`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/movies/${id}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('‚úì Movie deleted successfully!');
                    loadMoviesList();
                    loadStats();
                } else {
                    alert('‚úó ' + (result.error || 'Failed to delete movie'));
                }
            } catch (error) {
                console.error('Error deleting movie:', error);
                alert('‚úó Error deleting movie');
            }
        }
        
        // Initialize
        loadStats();
        loadMoviesList();
    </script>
</body>
</html>